{% extends "base.html" %}

{% block title %}Dashboard - Web Notes{% endblock %}

{% block content %}
<div class="col-12">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Dashboard</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item active">
                        <i class="bi bi-house me-1"></i>Dashboard
                    </li>
                </ol>
            </nav>
        </div>
        <div id="refreshButtonContainer" style="display: none;">
            <button class="btn btn-primary action-btn" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Loading dashboard data...</p>
    </div>

    <!-- Login Prompt for Unauthenticated Users -->
    <div id="loginPrompt" class="row justify-content-center" style="display: none;">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-lock-fill text-primary" style="font-size: 4rem;"></i>
                    <h4 class="mt-4 mb-3">Welcome to Web Notes</h4>
                    <p class="text-muted mb-4">
                        Please sign in to view your notes, pages, and sites.
                    </p>
                    <div id="dashboardSignInButton"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content (shown when authenticated) -->
    <div id="dashboardContent" style="display: none;">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <a href="/app/sites" class="text-decoration-none">
                    <div class="card stats-card card-hover" data-stat-refresh>
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">Total Sites</h6>
                                    <h3 class="mb-0" id="stats-sites">0</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="bi bi-globe" style="font-size: 2rem; opacity: 0.7;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3 mb-3">
                <a href="/app/pages" class="text-decoration-none">
                    <div class="card stats-card card-hover" data-stat-refresh>
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">Total Pages</h6>
                                    <h3 class="mb-0" id="stats-pages">0</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="bi bi-file-earmark" style="font-size: 2rem; opacity: 0.7;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3 mb-3">
                <a href="/app/notes" class="text-decoration-none">
                    <div class="card stats-card card-hover" data-stat-refresh>
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">Total Notes</h6>
                                    <h3 class="mb-0" id="stats-notes">0</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="bi bi-sticky" style="font-size: 2rem; opacity: 0.7;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card stats-card card-hover" data-stat-refresh>
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="card-title mb-1">Total Artifacts</h6>
                                <h3 class="mb-0" id="stats-artifacts">0</h3>
                            </div>
                            <div class="ms-3">
                                <i class="bi bi-magic" style="font-size: 2rem; opacity: 0.7;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <!-- Recent Pages -->
            <div class="col-md-6 mb-4">
                <div class="card content-wrapper">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark me-2 text-primary"></i>Recent Pages
                            </h5>
                            <a href="/app/pages" class="btn btn-sm btn-outline-primary">View All Pages</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recentPagesContent">
                            <div class="text-center py-4">
                                <i class="bi bi-file-earmark text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No pages found</p>
                                <a href="/app/sites" class="btn btn-primary btn-sm">Create First Page</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Notes -->
            <div class="col-md-6 mb-4">
                <div class="card content-wrapper">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-sticky me-2 text-primary"></i>Recent Notes
                            </h5>
                            <a href="/app/notes" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recentNotesContent">
                            <div class="text-center py-4">
                                <i class="bi bi-sticky text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">No notes found</p>
                                <a href="/app/notes" class="btn btn-primary btn-sm">Create First Note</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card content-wrapper">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning me-2 text-primary"></i>Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <a href="/app/sites" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-3">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold">New Site</div>
                                        <small>Add a new domain</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/app/notes" class="btn btn-outline-success w-100 d-flex align-items-center justify-content-center py-3">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold">New Note</div>
                                        <small>Create a note</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/app/artifacts" class="btn btn-outline-info w-100 d-flex align-items-center justify-content-center py-3">
                                    <i class="bi bi-magic me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold">Generate Artifact</div>
                                        <small>Use AI to enhance</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/app/llm-providers" class="btn btn-outline-warning w-100 d-flex align-items-center justify-content-center py-3">
                                    <i class="bi bi-cpu me-2"></i>
                                    <div class="text-start">
                                        <div class="fw-bold">LLM Settings</div>
                                        <small>Configure providers</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Make clickable stats cards more obvious */
a .stats-card {
    transition: all 0.2s ease;
    cursor: pointer;
}

a .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

a .stats-card .card-body {
    color: inherit;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard data management
    let dashboardData = null;

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatShortDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function renderRecentPages(pages) {
        const container = document.getElementById('recentPagesContent');

        if (!pages || pages.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-file-earmark text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No pages found</p>
                    <a href="/app/sites" class="btn btn-primary btn-sm">Create First Page</a>
                </div>
            `;
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        pages.forEach(page => {
            html += `
                <div class="list-group-item border-0 px-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-3">
                            <h6 class="mb-1">
                                <a href="/app/pages/${page.id}" class="text-decoration-none">
                                    ${page.title || 'Untitled Page'}
                                </a>
                            </h6>
                            <small class="text-muted d-block mb-1">
                                <i class="bi bi-globe me-1"></i>
                                ${page.site_domain || 'Unknown site'}
                            </small>
                            <small class="text-muted">
                                <i class="bi bi-sticky me-1"></i>
                                ${page.notes_count} notes
                            </small>
                        </div>
                        <div class="text-end text-nowrap">
                            <small class="text-muted d-block mb-1">${formatShortDate(page.updated_at)}</small>
                            <span class="badge bg-${page.is_active ? 'success' : 'secondary'}">
                                ${page.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function renderRecentNotes(notes) {
        const container = document.getElementById('recentNotesContent');

        if (!notes || notes.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-sticky text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No notes found</p>
                    <a href="/app/notes" class="btn btn-primary btn-sm">Create First Note</a>
                </div>
            `;
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        notes.forEach(note => {
            const contentPreview = note.content.length > 100
                ? note.content.substring(0, 100) + '...'
                : note.content;

            html += `
                <div class="list-group-item border-0 px-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 me-3">
                            <p class="mb-1">
                                <a href="/app/notes/${note.id}" class="text-decoration-none">
                                    ${contentPreview}
                                </a>
                            </p>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                ${formatDate(note.created_at)}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info">
                                ${note.artifacts_count} artifacts
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function updateDashboardUI(data) {
        // Update statistics
        document.getElementById('stats-sites').textContent = data.stats.total_sites;
        document.getElementById('stats-pages').textContent = data.stats.total_pages;
        document.getElementById('stats-notes').textContent = data.stats.total_notes;
        document.getElementById('stats-artifacts').textContent = data.stats.total_artifacts;

        // Render recent pages and notes
        renderRecentPages(data.recent_pages);
        renderRecentNotes(data.recent_notes);
    }

    async function loadDashboardData() {
        const spinner = document.getElementById('loadingSpinner');
        const content = document.getElementById('dashboardContent');
        const loginPrompt = document.getElementById('loginPrompt');
        const refreshButton = document.getElementById('refreshButtonContainer');

        // Show spinner while loading
        spinner.style.display = 'block';
        content.style.display = 'none';
        loginPrompt.style.display = 'none';

        if (!isAuthenticated()) {
            // Not authenticated - show login prompt
            spinner.style.display = 'none';
            loginPrompt.style.display = 'block';

            // Add Google Sign-In button to the dashboard login prompt
            const signInContainer = document.getElementById('dashboardSignInButton');
            signInContainer.innerHTML = `
                <div id="g_id_onload"
                     data-client_id="${'{{ google_client_id }}'}"
                     data-callback="handleDashboardSignIn"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="filled_blue"
                     data-text="sign_in_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
            `;

            // Render Google Sign-In button
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                google.accounts.id.renderButton(
                    signInContainer.querySelector('.g_id_signin'),
                    { theme: "filled_blue", size: "large" }
                );
            }

            return;
        }

        try {
            // Fetch dashboard data from API
            const response = await authenticatedFetch('/api/dashboard/data');

            if (!response.ok) {
                if (response.status === 401) {
                    // Token invalid - show login prompt
                    spinner.style.display = 'none';
                    loginPrompt.style.display = 'block';
                    return;
                }
                throw new Error(`Failed to fetch dashboard data: ${response.status}`);
            }

            const data = await response.json();
            dashboardData = data;

            // Update UI with data
            updateDashboardUI(data);

            // Show content and refresh button
            spinner.style.display = 'none';
            content.style.display = 'block';
            refreshButton.style.display = 'block';

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            spinner.style.display = 'none';

            // Show error message
            content.style.display = 'block';
            content.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load dashboard data. Please try refreshing the page.
                    <br><small>${error.message}</small>
                </div>
            `;
        }
    }

    function refreshDashboard() {
        // Show loading state
        const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
        const originalContent = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spin"></i>Refreshing...';
        refreshBtn.disabled = true;

        // Reload dashboard data
        loadDashboardData().then(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
        });
    }

    // Handle dashboard-specific sign in
    async function handleDashboardSignIn(response) {
        // Call the base handleGoogleSignIn function
        await handleGoogleSignIn(response);
    }

    // Initialize dashboard on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });
</script>
{% endblock %}