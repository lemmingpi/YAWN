{% extends "base.html" %}

{% block title %}{{ page.title or 'Page' }} - Page Details - Web Notes Dashboard{% endblock %}

{% block content %}
<div class="col-12">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/app/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="/app/sites/{{ page.site_id }}">Site</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ page.title or 'Page' }}</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="content-wrapper p-4 mb-4">
        <div class="row align-items-start">
            <div class="col-md-8">
                <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-file-earmark display-6 text-primary me-3 mt-1"></i>
                    <div class="flex-grow-1">
                        <h1 class="h3 mb-2">{{ page.title or 'Untitled Page' }}</h1>
                        <p class="text-muted mb-2">
                            <a href="{{ page.url }}" target="_blank" class="text-decoration-none">
                                {{ page.url }}
                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                            </a>
                        </p>
                        <div class="mb-3">
                            <span class="badge {{ 'bg-success' if page.is_active else 'bg-secondary' }}">
                                {{ 'Active' if page.is_active else 'Inactive' }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Page Metadata -->
                <div class="row text-muted small mb-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Created:</strong> {{ page.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                        <p class="mb-1"><strong>Last Updated:</strong> {{ page.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Page ID:</strong> {{ page.id }}</p>
                        <p class="mb-1"><strong>Site ID:</strong> {{ page.site_id }}</p>
                    </div>
                </div>

                {% if page.page_summary %}
                <div class="mb-3">
                    <h6 class="text-muted">Page Summary:</h6>
                    <p class="mb-0">{{ page.page_summary }}</p>
                </div>
                {% endif %}

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-muted mb-0">User Context:</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="showGenerateContextModal()">
                            <i class="bi bi-magic me-1"></i>Generate AI Context
                        </button>
                    </div>
                    <div id="userContextDisplay" class="p-2 border rounded bg-light" style="white-space: pre-wrap;">
                        {{ page.user_context or 'No context set. Click "Generate AI Context" to create an AI-powered summary.' }}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="editPage()">
                        <i class="bi bi-pencil me-1"></i>Edit Page
                    </button>
                    <a href="{{ page.url }}" target="_blank" class="btn btn-outline-info">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Visit Page
                    </a>
                    <a href="/app/sites/{{ page.site_id }}" class="btn btn-outline-secondary">
                        <i class="bi bi-globe me-1"></i>View Site
                    </a>
                    <button class="btn btn-outline-danger" onclick="deletePage()">
                        <i class="bi bi-trash me-1"></i>Delete Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-sticky display-4 mb-2"></i>
                    <h3 class="card-title mb-1" id="totalNotes">0</h3>
                    <p class="card-text">Total Notes</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-magic display-4 mb-2"></i>
                    <h3 class="card-title mb-1" id="totalArtifacts">0</h3>
                    <p class="card-text">Total Artifacts</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card text-white h-100">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-event display-4 mb-2"></i>
                    <h3 class="card-title mb-1" id="recentActivity">0</h3>
                    <p class="card-text">Recent Notes (7d)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="content-wrapper p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-sticky text-primary me-2"></i>Notes on this Page
            </h5>
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="notesSearch" placeholder="Search notes...">
            </div>
        </div>

        <div class="row" id="notesContainer">
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading notes...</span>
            </div>
        </div>

        <div id="notesEmpty" class="text-center py-4 d-none">
            <i class="bi bi-sticky display-1 text-muted"></i>
            <h6 class="mt-2 text-muted">No notes found for this page</h6>
        </div>
    </div>
</div>

<!-- Edit Page Modal -->
<div class="modal fade" id="editPageModal" tabindex="-1" aria-labelledby="editPageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPageModalLabel">Edit Page</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPageForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editPageUrl" class="form-label">URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editPageUrl" value="{{ page.url }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPageTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editPageTitle" value="{{ page.title or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="editPageSummary" class="form-label">Page Summary</label>
                        <textarea class="form-control" id="editPageSummary" rows="3">{{ page.page_summary or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPageContext" class="form-label">User Context</label>
                        <textarea class="form-control" id="editPageContext" rows="3">{{ page.user_context or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editPageActive" {{ 'checked' if page.is_active else '' }}>
                            <label class="form-check-label" for="editPageActive">
                                Active Page
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Update Page
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generate Context Modal -->
<div class="modal fade" id="generateContextModal" tabindex="-1" aria-labelledby="generateContextModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateContextModalLabel">Generate AI Context</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="generateContextForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>What is AI Context?</strong><br>
                        This generates a structured summary optimized for AI use (not human reading).
                        The AI will analyze your page and notes to extract key information like writing style,
                        technical details, or scholarly metadata based on the content type.
                    </div>

                    <div class="mb-3">
                        <label for="customInstructions" class="form-label">
                            Custom Instructions (Optional)
                        </label>
                        <textarea
                            class="form-control"
                            id="customInstructions"
                            rows="4"
                            placeholder="Add any specific instructions for the AI (e.g., 'Focus on character development' or 'Emphasize the methodology section')"></textarea>
                        <small class="text-muted">
                            Leave blank for automatic detection, or add guidance to customize the output.
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Estimated Cost:</label>
                        <div class="p-2 bg-light border rounded">
                            <span class="text-muted">~$0.00</span>
                            <small class="text-muted ms-2">(Placeholder - cost tracking coming soon)</small>
                        </div>
                    </div>

                    <div id="generationProgress" class="d-none">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 100%">Generating...</div>
                        </div>
                        <p class="text-muted mt-2 mb-0">
                            <i class="bi bi-hourglass-split"></i> Analyzing page and notes...
                        </p>
                    </div>

                    <div id="generationResult" class="d-none">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Context Generated!</strong>
                            <div class="mt-2">
                                <small>
                                    <strong>Content Type:</strong> <span id="detectedContentType"></span><br>
                                    <strong>Tokens Used:</strong> <span id="tokensUsed"></span><br>
                                    <strong>Generation Time:</strong> <span id="generationTime"></span>ms
                                </small>
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>Generated Context:</strong>
                        </div>
                        <div id="generatedContextPreview" class="p-3 border rounded bg-light" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        <i class="bi bi-magic me-1"></i>Generate Context
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.note-card {
    transition: all 0.2s ease;
    height: 100%;
}

.note-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.note-content {
    max-height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
class PageDetailManager {
    constructor() {
        this.pageId = {{ page.id }};
        this.siteId = {{ page.site_id }};

        this.initializeEventListeners();
        this.loadStats();
        this.loadNotes();
    }

    initializeEventListeners() {
        // Search input
        document.getElementById('notesSearch').addEventListener('input',
            this.debounce(() => this.loadNotes(), 300));

        // Edit page form
        document.getElementById('editPageForm').addEventListener('submit', (e) => this.handleEditPage(e));
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async loadStats() {
        try {
            const notesResponse = await authenticatedFetch(`/api/notes?page_id=${this.pageId}&limit=1000`);
            const notes = await notesResponse.json();

            document.getElementById('totalNotes').textContent = notes.length;

            // Calculate artifacts count and recent activity
            let totalArtifacts = 0;
            let recentNotes = 0;
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            for (const note of notes) {
                totalArtifacts += note.artifacts_count || 0;
                if (new Date(note.created_at) > sevenDaysAgo) {
                    recentNotes++;
                }
            }

            document.getElementById('totalArtifacts').textContent = totalArtifacts;
            document.getElementById('recentActivity').textContent = recentNotes;

        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async loadNotes() {
        try {
            const search = document.getElementById('notesSearch').value.trim();
            const params = new URLSearchParams({
                page_id: this.pageId,
                limit: 100
            });
            if (search) params.append('search', search);

            const response = await authenticatedFetch(`/api/notes?${params}`);
            const notes = await response.json();

            this.renderNotes(notes);
        } catch (error) {
            console.error('Error loading notes:', error);
        }
    }

    renderNotes(notes) {
        const container = document.getElementById('notesContainer');
        const emptyState = document.getElementById('notesEmpty');

        if (notes.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('d-none');
            return;
        }

        emptyState.classList.add('d-none');
        container.innerHTML = notes.map(note => `
            <div class="col-md-6 mb-3">
                <div class="card note-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge bg-success">${note.artifacts_count || 0} artifacts</span>
                            <small class="text-muted">
                                ${new Date(note.created_at).toLocaleDateString()}
                            </small>
                        </div>
                        <div class="note-content mb-3">
                            ${this.escapeHtml(note.content)}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Position: (${note.position_x}, ${note.position_y})
                            </small>
                            <a href="/app/notes/${note.id}" class="btn btn-sm btn-outline-primary">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async handleEditPage(e) {
        e.preventDefault();

        const pageData = {
            url: document.getElementById('editPageUrl').value.trim(),
            title: document.getElementById('editPageTitle').value.trim() || null,
            page_summary: document.getElementById('editPageSummary').value.trim() || null,
            user_context: document.getElementById('editPageContext').value.trim() || null,
            is_active: document.getElementById('editPageActive').checked
        };

        try {
            const response = await authenticatedFetch(`/api/pages/${this.pageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(pageData)
            });

            if (response.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPageModal'));
                modal.hide();
                location.reload(); // Reload to show updated data
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to update page'));
            }
        } catch (error) {
            console.error('Error updating page:', error);
            alert('Error: Failed to update page');
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Global functions for buttons
function editPage() {
    const modal = new bootstrap.Modal(document.getElementById('editPageModal'));
    modal.show();
}

async function deletePage() {
    if (!confirm('Are you sure you want to delete this page? This will also delete all associated notes and artifacts.')) {
        return;
    }

    try {
        const response = await authenticatedFetch(`/api/pages/{{ page.id }}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Page deleted successfully');
            window.location.href = '/app/sites/{{ page.site_id }}';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.detail || 'Failed to delete page'));
        }
    } catch (error) {
        console.error('Error deleting page:', error);
        alert('Error: Failed to delete page');
    }
}

// Global functions for context generation
function showGenerateContextModal() {
    const modal = new bootstrap.Modal(document.getElementById('generateContextModal'));

    // Reset modal state
    document.getElementById('customInstructions').value = '';
    document.getElementById('generationProgress').classList.add('d-none');
    document.getElementById('generationResult').classList.add('d-none');
    document.getElementById('generateBtn').disabled = false;

    modal.show();
}

async function generatePageContext(event) {
    event.preventDefault();

    const customInstructions = document.getElementById('customInstructions').value.trim();
    const generateBtn = document.getElementById('generateBtn');
    const progressDiv = document.getElementById('generationProgress');
    const resultDiv = document.getElementById('generationResult');

    // Show progress, hide previous results
    progressDiv.classList.remove('d-none');
    resultDiv.classList.add('d-none');
    generateBtn.disabled = true;

    try {
        // TODO: Get actual LLM provider ID (hardcoded to 1 for now)
        const requestData = {
            llm_provider_id: 1,
            custom_instructions: customInstructions || null
        };

        const response = await authenticatedFetch(`/api/pages/{{ page.id }}/generate-context`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to generate context');
        }

        const result = await response.json();

        // Hide progress, show results
        progressDiv.classList.add('d-none');
        resultDiv.classList.remove('d-none');

        // Populate result fields
        document.getElementById('detectedContentType').textContent = result.detected_content_type;
        document.getElementById('tokensUsed').textContent = result.tokens_used.toLocaleString();
        document.getElementById('generationTime').textContent = result.generation_time_ms;
        document.getElementById('generatedContextPreview').textContent = result.user_context;

        // Update the main page display
        document.getElementById('userContextDisplay').textContent = result.user_context;

        // Show success message
        setTimeout(() => {
            alert('Context generated successfully! The page has been updated.');
            const modal = bootstrap.Modal.getInstance(document.getElementById('generateContextModal'));
            modal.hide();
        }, 2000);

    } catch (error) {
        console.error('Error generating context:', error);
        progressDiv.classList.add('d-none');
        generateBtn.disabled = false;
        alert('Error: ' + error.message);
    }
}

// Attach form submit handler
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('generateContextForm').addEventListener('submit', generatePageContext);
});

// Initialize page detail manager when page loads
let pageDetailManager;
document.addEventListener('DOMContentLoaded', function() {
    pageDetailManager = new PageDetailManager();
});
</script>
{% endblock %}
